(()=>{"use strict";window.util={createEscapeHandler:e=>function(t){"Escape"===t.key&&e(t)},between:(e,t,n)=>Math.min(n,Math.max(t,e)),debounce:(e,t)=>{let n=null;return(...o)=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>{e(...o)}),t)}}},(()=>{const e=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("error",(()=>t("Произошла ошибка соединения"))),n.addEventListener("timeout",(()=>t(`Запрос не успел выполниться за ${n.timeout} мс`))),n.addEventListener("load",(()=>{let o;switch(n.status){case 200:e(n.response);break;default:o=`Статус ответа: ${n.status} ${n.statusText}`}o&&t(o)})),n.timeout=1e4,n};window.api={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),o.send()},upload:(t,n,o)=>{const r=e(n,o);r.open("POST","https://21.javascript.pages.academy/kekstagram"),r.send(t)}}})(),(()=>{let e=[];window.data={getPhotoList:()=>e,getPhotoItemByID:t=>e.find((e=>e.id===t)),setPhotoList:t=>{e=t.map(((e,t)=>Object.assign({id:t},e)))}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture"),t=t=>{const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n.dataset.id=t.id,n};window.photoList={render:e=>{const n=document.createDocumentFragment();for(const o of e)n.appendChild(t(o));return n},clear:()=>{document.querySelectorAll(".picture").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form");let n,o=e.querySelector(".img-filters__button--active");const r=e=>{o!==e.target&&e.target.classList.contains("img-filters__button")&&(o.classList.remove("img-filters__button--active"),o=e.target,o.classList.add("img-filters__button--active"),s())},s=window.util.debounce((()=>{n&&n()}),500);window.filters={show:()=>{e.classList.remove("img-filters--inactive"),t.addEventListener("click",r),s()},setChangeHandler:e=>{n=e},applyFilter:e=>{switch(o.id){case"filter-random":return e.sort((()=>Math.random()-.5)).slice(0,10);case"filter-discussed":return[...e].sort(((e,t)=>t.comments.length-e.comments.length));default:return e}}}})(),(()=>{let e,t=0;const n=(()=>{const e=document.querySelector(".big-picture");return{main:e,img:e.querySelector(".big-picture__img").querySelector("img"),likesCount:e.querySelector(".likes-count"),commentCounter:e.querySelector(".social__comment-count"),commentsCount:e.querySelector(".comments-count"),shownCommentsCount:e.querySelector(".shown-comments-count"),commentLoader:e.querySelector(".comments-loader"),commentList:e.querySelector(".social__comments"),caption:e.querySelector(".social__caption"),templateCommentItem:e.querySelector(".social__comment").cloneNode(!0),cancelButton:e.querySelector(".big-picture__cancel")}})(),o=window.util.createEscapeHandler((e=>{c(),e.preventDefault()})),r=e=>{const t=n.templateCommentItem.cloneNode(!0),o=t.querySelector(".social__picture"),r=t.querySelector(".social__text");return o.src=e.avatar,o.alt=e.name,r.textContent=e.message,t},s=()=>{const o=document.createDocumentFragment(),s=e.comments.slice(t,t+5);for(const e of s)o.appendChild(r(e));n.commentList.appendChild(o),t+=s.length,n.shownCommentsCount.textContent=t,t===e.comments.length&&n.commentLoader.classList.add("hidden")},c=()=>{e=void 0,document.body.classList.remove("modal-open"),n.main.classList.add("hidden"),n.commentLoader.removeEventListener("click",s),n.cancelButton.removeEventListener("click",c),document.removeEventListener("keydown",o)};window.bigPicture={show:r=>{e=r,t=0,n.img.src=e.url,n.likesCount.textContent=e.likes,n.commentsCount.textContent=e.comments.length,n.caption.textContent=e.description,n.commentList.innerHTML="",n.commentLoader.classList.remove("hidden"),s(),document.body.classList.add("modal-open"),n.main.classList.remove("hidden"),n.commentLoader.addEventListener("click",s),n.cancelButton.addEventListener("click",c),document.addEventListener("keydown",o)},hide:c}})(),(()=>{const e="none",t=document.querySelector(".img-upload__preview-container"),n=document.querySelector(".img-upload__effects"),o=t.querySelector(".img-upload__preview").querySelector("img"),r=t.querySelector(".img-upload__effect-level"),s=t.querySelector(".effect-level__line"),c=t.querySelector(".effect-level__pin"),i=t.querySelector(".effect-level__depth"),d=t.querySelector(".effect-level__value"),l=t.querySelector(".scale__control--smaller"),a=t.querySelector(".scale__control--bigger"),u=t.querySelector(".scale__control--value"),m={none:()=>"",chrome:e=>`grayscale(${e/100})`,sepia:e=>`sepia(${e/100})`,marvin:e=>`invert(${e}%)`,phobos:e=>`blur(${3*e/100}px)`,heat:e=>`brightness(${2*e/100+1})`};let v=100,p=e;const w=e=>{p=e.target.value,"none"===p?r.classList.add("hidden"):r.classList.remove("hidden"),E(p,20)},y=e=>{const t=e.target===l?-1:1;S(t)},L=e=>{e.preventDefault(),_(e)},g=e=>{e.preventDefault(),_(e)},h=e=>{e.preventDefault(),_(e),document.addEventListener("mousemove",g),document.addEventListener("mouseup",f)},f=e=>{e.preventDefault(),_(e),document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",f)},_=e=>{const t=s.getBoundingClientRect(),n=e.clientX-t.left,o=window.util.between(100*n/t.width,0,100);E(p,o)},E=(e,t)=>{if(o.className="effects__preview--"+e,o.style.filter=m[e](t),"none"===e)r.classList.add("hidden");else{r.classList.remove("hidden");const e=t*s.offsetWidth/100;c.style.left=e+"px",i.style.width=e+"px"}d.value=t},S=e=>{const t=v+25*e;v=window.util.between(t,25,100),q(v)},q=e=>{u.value=e+"%",o.style.transform=`scale(${e/100})`};window.editorEffect={reset:()=>{v=100,p=e,E(p,20),q(v)},enable:()=>{s.addEventListener("mousedown",L),c.addEventListener("mousedown",h),l.addEventListener("click",y),a.addEventListener("click",y),n.addEventListener("change",w)},disable:()=>{s.removeEventListener("mousedown",L),c.removeEventListener("mousedown",h),l.removeEventListener("click",y),a.removeEventListener("click",y),n.removeEventListener("change",w)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error");window.editorMessage={showSuccessMessage:()=>{const n=t.cloneNode(!0),o=n.querySelector(".success__button"),r=window.util.createEscapeHandler((()=>(c(),!0))),s=e=>{e.target===n&&(e.preventDefault(),c())},c=()=>{document.removeEventListener("keydown",r),n.removeEventListener("click",s),o.removeEventListener("click",c),n.remove()};e.appendChild(n),document.addEventListener("keydown",r),n.addEventListener("click",s),o.addEventListener("click",c)},showErrorMessage:()=>{const t=n.cloneNode(!0),o=t.querySelector(".error__button"),r=window.util.createEscapeHandler((e=>{c(),e.preventDefault()})),s=e=>{e.target===t&&(e.preventDefault(),c())},c=()=>{document.removeEventListener("keydown",r),t.removeEventListener("click",s),o.removeEventListener("click",c),t.remove()};e.appendChild(t),document.addEventListener("keydown",r),t.addEventListener("click",s),o.addEventListener("click",c)}}})(),(()=>{const e=/^#[\wа-яё]{1,19}$/,t=document.querySelector(".img-upload__form"),n=document.querySelector(".img-upload__input"),o=document.querySelector(".img-upload__overlay"),r=document.querySelector(".img-upload__cancel"),s=o.querySelector(".text__hashtags"),c=o.querySelector(".text__description"),i=window.util.createEscapeHandler((e=>(e.target.matches('input[type="text"], textarea')||(m(),e.preventDefault()),!1))),d=()=>{const e=v(s.value);s.setCustomValidity(e),s.style.borderColor=e?"red":"transparent"},l=e=>{e.preventDefault(),window.api.upload(new FormData(t),(()=>{window.editorMessage.showSuccessMessage(),o.classList.add("hidden"),a(),n.value=""}),(()=>{window.editorMessage.showErrorMessage(),o.classList.add("hidden"),a(),n.value=""}))},a=()=>{window.editorEffect.reset(),s.value="",c.value="",s.setCustomValidity(""),s.style.borderColor="transparent"},u=()=>{a(),window.editorEffect.enable(),o.classList.remove("hidden"),document.body.classList.add("modal-open"),r.addEventListener("click",m),document.addEventListener("keydown",i),s.addEventListener("input",d),t.addEventListener("submit",l)},m=()=>{a(),window.editorEffect.disable(),n.value="",o.classList.add("hidden"),document.body.classList.remove("modal-open"),r.removeEventListener("click",m),document.removeEventListener("keydown",i),s.removeEventListener("input",d),t.removeEventListener("submit",l)},v=t=>{const n=t.trim().toLowerCase();if(0===n.length)return"";const o=n.split(/\s+/),r=new Set(o);if(o.length!==r.size)return"Хэш-теги не должны повторяться";if(o.length>5)return"Количество хэш-тегов не больше 5";for(let t of o)if(!1===e.test(t))return`Неверный формат хэш-тега "${t}"`;return""};n.addEventListener("change",u),window.editor={show:u,hide:m}})(),(()=>{const e=document.querySelector(".pictures");window.api.load((t=>{window.data.setPhotoList(t),window.filters.setChangeHandler((()=>{const t=window.data.getPhotoList(),n=window.filters.applyFilter(t);window.photoList.clear(),e.appendChild(window.photoList.render(n))})),window.filters.show(),e.addEventListener("click",(e=>{if(e.target.matches('*[class^="picture"]')){e.preventDefault();const t=parseInt(e.target.dataset.id||e.target.closest(".picture").dataset.id,10),n=window.data.getPhotoItemByID(t);window.bigPicture.show(n)}}))}),(e=>{const t=document.createElement("div");t.style.zIndex=100,t.style.margin="0 auto",t.style.lineHeight="60px",t.style.textAlign="center",t.style.backgroundColor="red",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))})()})();